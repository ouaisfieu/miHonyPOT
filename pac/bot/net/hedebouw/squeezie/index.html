<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="Plaidoyer Citoyen - Poste de travail avec Graph View">
    <title>Plaidoyer Citoyen 4.0 â€” Graph Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
    --bg-deep: #0a0a0f;
    --bg-base: #0f0f16;
    --bg-card: #151520;
    --bg-elevated: #1a1a28;
    --bg-input: #12121c;
    
    --green-soft: #7fefaf;
    --green-medium: #5fd38d;
    --green-dark: #3da86d;
    --green-glow: rgba(127, 239, 175, 0.25);
    --green-subtle: rgba(127, 239, 175, 0.08);
    
    --lilac-soft: #c9b8ff;
    --lilac-medium: #a78bfa;
    --lilac-dark: #8b5cf6;
    --lilac-glow: rgba(201, 184, 255, 0.25);
    --lilac-subtle: rgba(201, 184, 255, 0.08);
    
    --cyan: #67e8f9;
    --cyan-glow: rgba(103, 232, 249, 0.3);
    --orange: #fbbf24;
    --orange-glow: rgba(251, 191, 36, 0.3);
    --rose: #fb7185;
    --rose-glow: rgba(251, 113, 133, 0.3);
    
    --text-primary: #f0f0f8;
    --text-secondary: #a0a0b8;
    --text-muted: #606078;
    
    --border: rgba(127, 239, 175, 0.15);
    --border-lilac: rgba(201, 184, 255, 0.15);
    
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    
    --shadow-glow-green: 0 0 20px var(--green-glow);
    --shadow-glow-lilac: 0 0 20px var(--lilac-glow);
    
    --transition: 0.2s ease;
    --font-main: 'Nunito', system-ui, sans-serif;
    --font-mono: 'Space Mono', monospace;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }

body {
    font-family: var(--font-main);
    background: var(--bg-deep);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    min-height: 100dvh;
}

.header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10, 10, 15, 0.92);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0.6rem 1rem;
}

.header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1800px;
    margin: 0 auto;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--green-soft), var(--lilac-soft));
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    box-shadow: var(--shadow-glow-green);
}

.logo-text {
    font-weight: 700;
    font-size: 0.95rem;
    background: linear-gradient(135deg, var(--green-soft), var(--lilac-soft));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.logo-badge {
    font-size: 0.6rem;
    background: var(--lilac-subtle);
    color: var(--lilac-soft);
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 0.25rem;
}

.header-actions {
    display: flex;
    gap: 0.4rem;
}

.main-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

@media (min-width: 1024px) {
    .main-container {
        flex-direction: row;
    }
}

/* Sidebar */
.sidebar {
    background: var(--bg-base);
    border-bottom: 1px solid var(--border);
    padding: 0.5rem;
    overflow-x: auto;
}

@media (min-width: 1024px) {
    .sidebar {
        width: 200px;
        min-width: 200px;
        border-bottom: none;
        border-right: 1px solid var(--border);
        padding: 1rem 0.75rem;
        height: calc(100vh - 52px);
        height: calc(100dvh - 52px);
        overflow-y: auto;
        overflow-x: hidden;
    }
}

.nav-tabs {
    display: flex;
    gap: 0.25rem;
}

@media (min-width: 1024px) {
    .nav-tabs {
        flex-direction: column;
    }
}

.nav-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-md);
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-family: var(--font-main);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
}

.nav-tab:hover {
    background: var(--bg-elevated);
    color: var(--text-secondary);
}

.nav-tab.active {
    background: var(--green-subtle);
    color: var(--green-soft);
}

.nav-tab-icon {
    font-size: 1rem;
}

.nav-divider {
    height: 1px;
    background: var(--border);
    margin: 0.5rem 0;
    display: none;
}

@media (min-width: 1024px) {
    .nav-divider {
        display: block;
    }
}

/* Main content */
.main {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
}

@media (min-width: 1024px) {
    .main {
        height: calc(100vh - 52px);
        height: calc(100dvh - 52px);
        padding: 1.5rem 2rem;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section {
    display: none;
    animation: fadeIn 0.3s ease;
}

.section.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRAPH VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.graph-container {
    position: relative;
    width: 100%;
    height: 500px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

@media (min-width: 768px) {
    .graph-container {
        height: 600px;
    }
}

@media (min-width: 1024px) {
    .graph-container {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
}

.graph-canvas {
    width: 100%;
    height: 100%;
    cursor: grab;
}

.graph-canvas:active {
    cursor: grabbing;
}

.graph-controls {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    display: flex;
    gap: 0.5rem;
    z-index: 10;
}

.graph-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
}

.graph-btn:hover {
    background: var(--green-subtle);
    border-color: var(--green-soft);
}

.graph-legend {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(15, 15, 22, 0.9);
    backdrop-filter: blur(8px);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    z-index: 10;
}

.legend-title {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.legend-dot.actor { background: var(--green-soft); }
.legend-dot.cause { background: var(--rose); }
.legend-dot.effect { background: var(--cyan); }
.legend-dot.concept { background: var(--lilac-soft); }
.legend-dot.veille { background: var(--orange); }

.graph-stats {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    background: rgba(15, 15, 22, 0.9);
    backdrop-filter: blur(8px);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
    z-index: 10;
}

/* Node tooltip */
.graph-tooltip {
    position: absolute;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.15s ease;
    max-width: 200px;
}

.graph-tooltip.visible {
    opacity: 1;
}

.tooltip-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.tooltip-type {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
    overflow: hidden;
    transition: all var(--transition);
}

.card:hover {
    border-color: rgba(127, 239, 175, 0.3);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    cursor: pointer;
    user-select: none;
}

.card-header:active {
    background: var(--bg-elevated);
}

.card-title-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-icon {
    width: 40px;
    height: 40px;
    background: var(--green-subtle);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.card-icon.lilac { background: var(--lilac-subtle); }
.card-icon.orange { background: rgba(251, 191, 36, 0.1); }
.card-icon.cyan { background: rgba(103, 232, 249, 0.1); }

.card-title {
    font-weight: 700;
    font-size: 1rem;
}

.card-number {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-muted);
}

.card-toggle {
    font-size: 1.25rem;
    color: var(--text-muted);
    transition: transform var(--transition);
}

.card.open .card-toggle {
    transform: rotate(180deg);
}

.card-body {
    display: none;
    padding: 0 1rem 1rem;
}

.card.open .card-body {
    display: block;
}

.card-description {
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    padding: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    border-left: 3px solid var(--green-soft);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM ELEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.4rem;
    color: var(--text-secondary);
}

.form-input,
.form-textarea,
.form-select {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-main);
    font-size: 1rem;
    transition: all var(--transition);
    -webkit-appearance: none;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
    outline: none;
    border-color: var(--green-soft);
    box-shadow: 0 0 0 3px var(--green-glow);
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
}

@media (min-width: 480px) {
    .form-row.two-col {
        grid-template-columns: 1fr 1fr;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.6rem 1rem;
    border-radius: var(--radius-md);
    font-family: var(--font-main);
    font-weight: 600;
    font-size: 0.85rem;
    border: none;
    cursor: pointer;
    transition: all var(--transition);
    min-height: 44px;
    white-space: nowrap;
}

.btn:active {
    transform: scale(0.97);
}

.btn-primary {
    background: linear-gradient(135deg, var(--green-soft), var(--green-medium));
    color: var(--bg-deep);
}

.btn-primary:hover {
    box-shadow: var(--shadow-glow-green);
}

.btn-secondary {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    border-color: var(--lilac-soft);
    color: var(--lilac-soft);
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    padding: 0.5rem;
}

.btn-ghost:hover {
    color: var(--green-soft);
    background: var(--green-subtle);
}

.btn-sm {
    padding: 0.4rem 0.75rem;
    font-size: 0.8rem;
    min-height: 36px;
}

.btn-danger {
    background: rgba(251, 113, 133, 0.15);
    color: var(--rose);
    border: 1px solid rgba(251, 113, 133, 0.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 600px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1rem;
    text-align: center;
}

.stat-value {
    font-family: var(--font-mono);
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--green-soft);
    line-height: 1.2;
}

.stat-value.lilac { color: var(--lilac-soft); }
.stat-value.cyan { color: var(--cyan); }
.stat-value.orange { color: var(--orange); }

.stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.progress-section {
    margin-bottom: 1.5rem;
}

.progress-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.progress-bar-container {
    background: var(--bg-input);
    border-radius: var(--radius-lg);
    height: 12px;
    overflow: hidden;
    margin-bottom: 0.75rem;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--green-soft), var(--lilac-soft));
    border-radius: var(--radius-lg);
    transition: width 0.5s ease;
}

.phase-progress {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
}

.phase-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    text-align: center;
}

.phase-item.voir { border-color: rgba(103, 232, 249, 0.3); }
.phase-item.juger { border-color: rgba(201, 184, 255, 0.3); }
.phase-item.agir { border-color: rgba(251, 191, 36, 0.3); }

.phase-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.phase-item.voir .phase-label { color: var(--cyan); }
.phase-item.juger .phase-label { color: var(--lilac-soft); }
.phase-item.agir .phase-label { color: var(--orange); }

.phase-value {
    font-family: var(--font-mono);
    font-size: 1.25rem;
    font-weight: 700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TREE & LISTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tree-container {
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-top: 1rem;
}

.tree-level {
    margin-bottom: 1rem;
}

.tree-level:last-child {
    margin-bottom: 0;
}

.tree-level-title {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.tree-items {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.tree-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.6rem 0.75rem;
    font-size: 0.9rem;
}

.tree-item.effect { border-left: 3px solid var(--cyan); }
.tree-item.cause { border-left: 3px solid var(--rose); }
.tree-item.problem {
    background: var(--lilac-subtle);
    border: 1px solid var(--lilac-soft);
    border-left: 3px solid var(--lilac-soft);
    font-weight: 600;
}

.tree-item-text { flex: 1; }

.tree-item-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1rem;
    opacity: 0.6;
    transition: all var(--transition);
}

.tree-item-delete:hover {
    opacity: 1;
    color: var(--rose);
}

.tree-add-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.tree-add-row .form-input {
    flex: 1;
}

/* Actors & Veille */
.actors-grid, .veille-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
}

.actor-card, .veille-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 0.75rem;
}

.actor-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.actor-avatar.ally { background: rgba(127, 239, 175, 0.2); }
.actor-avatar.target { background: rgba(201, 184, 255, 0.2); }
.actor-avatar.neutral { background: rgba(251, 191, 36, 0.2); }
.actor-avatar.opponent { background: rgba(251, 113, 133, 0.2); }

.actor-info, .veille-info { flex: 1; min-width: 0; }
.actor-name { font-weight: 600; font-size: 0.9rem; }
.actor-meta { font-size: 0.75rem; color: var(--text-muted); }

/* Checklist */
.checklist {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.checklist-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition);
    user-select: none;
}

.checklist-item:active { transform: scale(0.98); }

.checklist-item.completed {
    background: var(--green-subtle);
    border-color: var(--green-soft);
}

.checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition);
}

.checklist-item.completed .checkbox {
    background: var(--green-soft);
    border-color: var(--green-soft);
    color: var(--bg-deep);
}

.checklist-text { flex: 1; font-size: 0.9rem; }

.checklist-item.completed .checklist-text {
    text-decoration: line-through;
    opacity: 0.7;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    animation: modalIn 0.3s ease;
}

@keyframes modalIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg-card);
}

.modal-title { font-weight: 700; font-size: 1.1rem; }

.modal-close {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-elevated);
    border: none;
    color: var(--text-secondary);
    font-size: 1.25rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
}

.modal-close:hover { background: var(--rose); color: white; }

.modal-body { padding: 1.25rem; }

.modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

/* Export grid */
.export-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
}

.export-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    padding: 1rem;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-main);
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all var(--transition);
}

.export-btn:hover {
    border-color: var(--green-soft);
    background: var(--green-subtle);
}

.export-btn-icon { font-size: 1.5rem; }

/* Toast */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.toast {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    animation: toastIn 0.3s ease;
    font-size: 0.9rem;
}

@keyframes toastIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-color: var(--green-soft); }
.toast.error { border-color: var(--rose); }

/* Utilities */
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.text-sm { font-size: 0.85rem; }

.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

/* Quick add bar for graph */
.quick-add-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.quick-add-btn {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-family: var(--font-main);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all var(--transition);
}

.quick-add-btn:hover {
    border-color: var(--green-soft);
    color: var(--green-soft);
}

.quick-add-btn.active {
    background: var(--green-subtle);
    border-color: var(--green-soft);
    color: var(--green-soft);
}
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <div class="logo-icon">ğŸ—³ï¸</div>
                    <span class="logo-text">Plaidoyer Citoyen</span>
                    <span class="logo-badge">Graph</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="openModal('export-modal')" title="Exporter">ğŸ“¤</button>
                    <button class="btn btn-ghost" onclick="openModal('import-modal')" title="Importer">ğŸ“¥</button>
                    <button class="btn btn-primary btn-sm" onclick="saveProject()">ğŸ’¾</button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-section="graph">
                        <span class="nav-tab-icon">ğŸ•¸ï¸</span>
                        <span>Graph</span>
                    </button>
                    <button class="nav-tab" data-section="dashboard">
                        <span class="nav-tab-icon">ğŸ“Š</span>
                        <span>Tableau</span>
                    </button>
                    <div class="nav-divider"></div>
                    <button class="nav-tab" data-section="voir">
                        <span class="nav-tab-icon">ğŸ‘ï¸</span>
                        <span>Voir</span>
                    </button>
                    <button class="nav-tab" data-section="juger">
                        <span class="nav-tab-icon">âš–ï¸</span>
                        <span>Juger</span>
                    </button>
                    <button class="nav-tab" data-section="agir">
                        <span class="nav-tab-icon">ğŸ¯</span>
                        <span>Agir</span>
                    </button>
                    <div class="nav-divider"></div>
                    <button class="nav-tab" data-section="veille">
                        <span class="nav-tab-icon">ğŸ“¡</span>
                        <span>Veille</span>
                    </button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="main">
                <!-- GRAPH VIEW -->
                <section id="graph" class="section active">
                    <div class="section-header">
                        <h1 class="section-title">ğŸ•¸ï¸ Vue Graphe</h1>
                        <p class="section-subtitle">Visualisez les connexions de votre projet</p>
                    </div>

                    <div class="quick-add-bar">
                        <button class="quick-add-btn" onclick="openModal('node-modal')" data-type="concept">
                            <span>â•</span> Concept
                        </button>
                        <button class="quick-add-btn" onclick="openModal('actor-modal')">
                            <span>ğŸ‘¤</span> Acteur
                        </button>
                        <button class="quick-add-btn" onclick="addQuickNode('cause')">
                            <span>ğŸŒ±</span> Cause
                        </button>
                        <button class="quick-add-btn" onclick="addQuickNode('effect')">
                            <span>ğŸŒ¿</span> Effet
                        </button>
                        <button class="quick-add-btn" onclick="openModal('link-modal')">
                            <span>ğŸ”—</span> Lien
                        </button>
                    </div>

                    <div class="graph-container" id="graph-container">
                        <canvas id="graph-canvas" class="graph-canvas"></canvas>
                        
                        <div class="graph-controls">
                            <button class="graph-btn" onclick="GraphView.zoomIn()" title="Zoom +">â•</button>
                            <button class="graph-btn" onclick="GraphView.zoomOut()" title="Zoom -">â–</button>
                            <button class="graph-btn" onclick="GraphView.resetView()" title="Reset">ğŸ¯</button>
                            <button class="graph-btn" onclick="GraphView.togglePhysics()" title="Physique" id="physics-btn">âš¡</button>
                        </div>

                        <div class="graph-legend">
                            <div class="legend-title">LÃ©gende</div>
                            <div class="legend-item"><span class="legend-dot actor"></span> Acteur</div>
                            <div class="legend-item"><span class="legend-dot cause"></span> Cause</div>
                            <div class="legend-item"><span class="legend-dot effect"></span> Effet</div>
                            <div class="legend-item"><span class="legend-dot concept"></span> Concept</div>
                            <div class="legend-item"><span class="legend-dot veille"></span> Veille</div>
                        </div>

                        <div class="graph-stats" id="graph-stats">
                            NÅ“uds: 0 | Liens: 0
                        </div>

                        <div class="graph-tooltip" id="graph-tooltip">
                            <div class="tooltip-title"></div>
                            <div class="tooltip-type"></div>
                        </div>
                    </div>
                </section>

                <!-- DASHBOARD -->
                <section id="dashboard" class="section">
                    <div class="section-header">
                        <h1 class="section-title">ğŸ“Š Tableau de bord</h1>
                        <p class="section-subtitle">Vue d'ensemble de votre projet</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-progress">0%</div>
                            <div class="stat-label">Progression</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value lilac" id="stat-nodes">0</div>
                            <div class="stat-label">NÅ“uds</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value cyan" id="stat-links">0</div>
                            <div class="stat-label">Liens</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value orange" id="stat-veille">0</div>
                            <div class="stat-label">Veille</div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-title">ğŸš€ Progression globale</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="global-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="phase-progress">
                            <div class="phase-item voir">
                                <div class="phase-label">ğŸ‘ï¸ Voir</div>
                                <div class="phase-value" id="prog-voir">0%</div>
                            </div>
                            <div class="phase-item juger">
                                <div class="phase-label">âš–ï¸ Juger</div>
                                <div class="phase-value" id="prog-juger">0%</div>
                            </div>
                            <div class="phase-item agir">
                                <div class="phase-label">ğŸ¯ Agir</div>
                                <div class="phase-value" id="prog-agir">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="card open">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon">ğŸ“</div>
                                <div><div class="card-title">Projet</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Nom du projet</label>
                                <input type="text" class="form-input" data-field="project_name" placeholder="Mon projet de plaidoyer">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" data-field="project_description" placeholder="DÃ©crivez votre projet..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VOIR -->
                <section id="voir" class="section">
                    <div class="section-header">
                        <h1 class="section-title">ğŸ‘ï¸ Phase VOIR</h1>
                        <p class="section-subtitle">Observer et comprendre</p>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon cyan">ğŸ¡</div>
                                <div><div class="card-title">Domino du Changement</div><div class="card-number">#1</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">ğŸ”¥ Pourquoi agir ?</label>
                                <textarea class="form-textarea" data-field="domino_pourquoi" placeholder="Votre motivation..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ğŸ’ Valeurs</label>
                                <textarea class="form-textarea" data-field="domino_valeurs" placeholder="Vos valeurs..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ğŸ¯ Changements souhaitÃ©s</label>
                                <textarea class="form-textarea" data-field="domino_changements" placeholder="Les changements..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon cyan">ğŸ—ºï¸</div>
                                <div><div class="card-title">Cartographie des acteurs</div><div class="card-number">#4</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary mb-2" onclick="openModal('actor-modal')">â• Ajouter un acteur</button>
                            <div class="actors-grid" id="actors-list">
                                <div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><p>Aucun acteur</p></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- JUGER -->
                <section id="juger" class="section">
                    <div class="section-header">
                        <h1 class="section-title">âš–ï¸ Phase JUGER</h1>
                        <p class="section-subtitle">Analyser et Ã©valuer</p>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon lilac">ğŸ“Š</div>
                                <div><div class="card-title">Analyse SWOT</div><div class="card-number">#6</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label class="form-label">ğŸ’ª Forces</label>
                                    <textarea class="form-textarea" data-field="swot_forces" placeholder="Atouts..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">âš ï¸ Faiblesses</label>
                                    <textarea class="form-textarea" data-field="swot_faiblesses" placeholder="Points faibles..."></textarea>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label class="form-label">ğŸŒ± OpportunitÃ©s</label>
                                    <textarea class="form-textarea" data-field="swot_opportunites" placeholder="OpportunitÃ©s..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ğŸŒ©ï¸ Menaces</label>
                                    <textarea class="form-textarea" data-field="swot_menaces" placeholder="Menaces..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon lilac">ğŸŒ³</div>
                                <div><div class="card-title">Arbre Ã  problÃ¨me</div><div class="card-number">#8</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">ğŸ¯ ProblÃ¨me central</label>
                                <input type="text" class="form-input" data-field="arbre_probleme" id="tree-problem-input" placeholder="Le problÃ¨me central..." oninput="updateTreeProblem()">
                            </div>
                            <div class="tree-container">
                                <div class="tree-level">
                                    <div class="tree-level-title">ğŸŒ¿ Effets</div>
                                    <div class="tree-items" id="tree-effects-list"></div>
                                    <div class="tree-add-row">
                                        <input type="text" class="form-input" id="effect-input" placeholder="Ajouter un effet...">
                                        <button class="btn btn-secondary btn-sm" onclick="addTreeItem('effect')">+</button>
                                    </div>
                                </div>
                                <div class="tree-level">
                                    <div class="tree-items">
                                        <div class="tree-item problem">
                                            <span class="tree-item-text" id="tree-problem-display">â†’ ProblÃ¨me central â†</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tree-level">
                                    <div class="tree-level-title">ğŸŒ± Causes</div>
                                    <div class="tree-items" id="tree-causes-list"></div>
                                    <div class="tree-add-row">
                                        <input type="text" class="form-input" id="cause-input" placeholder="Ajouter une cause...">
                                        <button class="btn btn-secondary btn-sm" onclick="addTreeItem('cause')">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AGIR -->
                <section id="agir" class="section">
                    <div class="section-header">
                        <h1 class="section-title">ğŸ¯ Phase AGIR</h1>
                        <p class="section-subtitle">Planifier et agir</p>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon orange">ğŸ¯</div>
                                <div><div class="card-title">Objectifs SMART</div><div class="card-number">#10</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">ğŸ”¹ SpÃ©cifique</label>
                                <input type="text" class="form-input" data-field="smart_s" placeholder="Objectif prÃ©cis...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ğŸ“ Mesurable</label>
                                <input type="text" class="form-input" data-field="smart_m" placeholder="Indicateurs...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">âœ… Atteignable</label>
                                <input type="text" class="form-input" data-field="smart_a" placeholder="Ressources...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ğŸ¯ RÃ©aliste</label>
                                <input type="text" class="form-input" data-field="smart_r" placeholder="Pertinence...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">â° Temporel</label>
                                <input type="text" class="form-input" data-field="smart_t" placeholder="Ã‰chÃ©ance...">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" onclick="toggleCard(this.parentElement)">
                            <div class="card-title-group">
                                <div class="card-icon orange">âœ…</div>
                                <div><div class="card-title">Check-list rencontre</div><div class="card-number">#13</div></div>
                            </div>
                            <span class="card-toggle">â–¼</span>
                        </div>
                        <div class="card-body">
                            <div class="checklist" id="checklist"></div>
                        </div>
                    </div>
                </section>

                <!-- VEILLE -->
                <section id="veille" class="section">
                    <div class="section-header">
                        <h1 class="section-title">ğŸ“¡ Veille</h1>
                        <p class="section-subtitle">Suivez l'actualitÃ©</p>
                    </div>
                    <button class="btn btn-primary mb-2" onclick="openModal('veille-modal')">â• Ajouter</button>
                    <div class="veille-list" id="veille-list">
                        <div class="empty-state"><div class="empty-state-icon">ğŸ“°</div><p>Aucune source</p></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“¤ Exporter</h2>
                <button class="modal-close" onclick="closeModal('export-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="export-grid">
                    <button class="export-btn" onclick="exportProject('json')"><span class="export-btn-icon">ğŸ“„</span>JSON</button>
                    <button class="export-btn" onclick="exportProject('md')"><span class="export-btn-icon">ğŸ“</span>Markdown</button>
                    <button class="export-btn" onclick="exportProject('html')"><span class="export-btn-icon">ğŸŒ</span>HTML</button>
                    <button class="export-btn" onclick="exportProject('gexf')"><span class="export-btn-icon">ğŸ•¸ï¸</span>GEXF</button>
                    <button class="export-btn" onclick="exportProject('csv')"><span class="export-btn-icon">ğŸ“Š</span>CSV</button>
                    <button class="export-btn" onclick="window.print()"><span class="export-btn-icon">ğŸ–¨ï¸</span>Imprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“¥ Importer</h2>
                <button class="modal-close" onclick="closeModal('import-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="file" id="import-file" accept=".json" onchange="importProject(event)" style="display:none">
                <button class="btn btn-primary" onclick="document.getElementById('import-file').click()" style="width:100%">
                    ğŸ“ Choisir un fichier JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Actor Modal -->
    <div class="modal-overlay" id="actor-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ‘¤ Ajouter un acteur</h2>
                <button class="modal-close" onclick="closeModal('actor-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom</label>
                    <input type="text" class="form-input" id="actor-name" placeholder="Nom...">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="actor-type">
                        <option value="ally">ğŸ¤ AlliÃ©</option>
                        <option value="target">ğŸ¯ Cible</option>
                        <option value="neutral">âš–ï¸ Neutre</option>
                        <option value="opponent">ğŸš« Opposant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Influence</label>
                    <select class="form-select" id="actor-influence">
                        <option value="faible">Faible</option>
                        <option value="moyen" selected>Moyen</option>
                        <option value="fort">Fort</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('actor-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="addActor()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Node Modal -->
    <div class="modal-overlay" id="node-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">â• Ajouter un concept</h2>
                <button class="modal-close" onclick="closeModal('node-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom du concept</label>
                    <input type="text" class="form-input" id="node-name" placeholder="Ex: Justice sociale...">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="node-type">
                        <option value="concept">ğŸ’¡ Concept</option>
                        <option value="cause">ğŸŒ± Cause</option>
                        <option value="effect">ğŸŒ¿ Effet</option>
                        <option value="value">ğŸ’ Valeur</option>
                        <option value="action">âœŠ Action</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('node-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="addGraphNode()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal-overlay" id="link-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”— CrÃ©er un lien</h2>
                <button class="modal-close" onclick="closeModal('link-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-select" id="link-source"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cible</label>
                    <select class="form-select" id="link-target"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Type de relation</label>
                    <select class="form-select" id="link-type">
                        <option value="causes">â†’ cause</option>
                        <option value="influences">â†’ influence</option>
                        <option value="supports">â†’ soutient</option>
                        <option value="opposes">â†’ s'oppose Ã </option>
                        <option value="related">â†” liÃ© Ã </option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('link-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="addGraphLink()">CrÃ©er</button>
            </div>
        </div>
    </div>

    <!-- Veille Modal -->
    <div class="modal-overlay" id="veille-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“° Ajouter une source</h2>
                <button class="modal-close" onclick="closeModal('veille-modal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="veille-title" placeholder="Titre...">
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-input" id="veille-url" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">CatÃ©gorie</label>
                    <select class="form-select" id="veille-category">
                        <option value="politique">ğŸ›ï¸ Politique</option>
                        <option value="social">ğŸ‘¥ Social</option>
                        <option value="economique">ğŸ’° Ã‰conomique</option>
                        <option value="environnement">ğŸŒ Environnement</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('veille-modal')">Annuler</button>
                <button class="btn btn-primary" onclick="addVeille()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let data = {
    meta: { version: '4.0', created: new Date().toISOString(), updated: new Date().toISOString() },
    fields: {},
    actors: [],
    veille: [],
    checklist: {},
    tree: { causes: [], effects: [] },
    graph: { nodes: [], links: [] }
};

const CHECKLIST_ITEMS = [
    "DÃ©finir l'objectif", "Identifier les participants", "PrÃ©parer les arguments",
    "Anticiper les contre-arguments", "PrÃ©parer les documents", "DÃ©finir la demande",
    "PrÃ©voir les questions", "Ã‰tablir le plan de suivi"
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRAPH VIEW ENGINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GraphView = (function() {
    let canvas, ctx;
    let width, height;
    let nodes = [];
    let links = [];
    let scale = 1;
    let offsetX = 0, offsetY = 0;
    let isDragging = false;
    let isPanning = false;
    let dragNode = null;
    let lastMouse = { x: 0, y: 0 };
    let physicsEnabled = true;
    let animationId = null;
    let hoveredNode = null;
    
    const COLORS = {
        actor: '#7fefaf',
        cause: '#fb7185',
        effect: '#67e8f9',
        concept: '#c9b8ff',
        veille: '#fbbf24',
        value: '#a78bfa',
        action: '#fbbf24',
        problem: '#c9b8ff'
    };

    function init() {
        canvas = document.getElementById('graph-canvas');
        if (!canvas) return;
        
        ctx = canvas.getContext('2d');
        resize();
        
        window.addEventListener('resize', debounce(resize, 200));
        
        canvas.addEventListener('mousedown', onMouseDown);
        canvas.addEventListener('mousemove', onMouseMove);
        canvas.addEventListener('mouseup', onMouseUp);
        canvas.addEventListener('mouseleave', onMouseUp);
        canvas.addEventListener('wheel', onWheel, { passive: false });
        
        // Touch events
        canvas.addEventListener('touchstart', onTouchStart, { passive: false });
        canvas.addEventListener('touchmove', onTouchMove, { passive: false });
        canvas.addEventListener('touchend', onTouchEnd);
        
        loadFromData();
        animate();
    }

    function resize() {
        const container = document.getElementById('graph-container');
        if (!container) return;
        
        const rect = container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        
        width = rect.width;
        height = rect.height;
        
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        
        ctx.scale(dpr, dpr);
    }

    function loadFromData() {
        nodes = [];
        links = [];
        
        // Add actors as nodes
        data.actors.forEach(actor => {
            if (!nodes.find(n => n.id === 'actor_' + actor.id)) {
                nodes.push({
                    id: 'actor_' + actor.id,
                    label: actor.name,
                    type: 'actor',
                    x: Math.random() * (width - 100) + 50,
                    y: Math.random() * (height - 100) + 50,
                    vx: 0, vy: 0,
                    radius: actor.influence === 'fort' ? 25 : actor.influence === 'moyen' ? 20 : 15
                });
            }
        });
        
        // Add causes
        (data.tree.causes || []).forEach(cause => {
            if (!nodes.find(n => n.id === 'cause_' + cause.id)) {
                nodes.push({
                    id: 'cause_' + cause.id,
                    label: cause.text,
                    type: 'cause',
                    x: Math.random() * (width - 100) + 50,
                    y: Math.random() * (height - 100) + 50,
                    vx: 0, vy: 0,
                    radius: 18
                });
            }
        });
        
        // Add effects
        (data.tree.effects || []).forEach(effect => {
            if (!nodes.find(n => n.id === 'effect_' + effect.id)) {
                nodes.push({
                    id: 'effect_' + effect.id,
                    label: effect.text,
                    type: 'effect',
                    x: Math.random() * (width - 100) + 50,
                    y: Math.random() * (height - 100) + 50,
                    vx: 0, vy: 0,
                    radius: 18
                });
            }
        });
        
        // Add custom graph nodes
        (data.graph.nodes || []).forEach(node => {
            if (!nodes.find(n => n.id === node.id)) {
                nodes.push({
                    ...node,
                    x: node.x || Math.random() * (width - 100) + 50,
                    y: node.y || Math.random() * (height - 100) + 50,
                    vx: 0, vy: 0,
                    radius: node.radius || 20
                });
            }
        });
        
        // Add veille as nodes
        data.veille.forEach(v => {
            if (!nodes.find(n => n.id === 'veille_' + v.id)) {
                nodes.push({
                    id: 'veille_' + v.id,
                    label: v.title.substring(0, 30),
                    type: 'veille',
                    x: Math.random() * (width - 100) + 50,
                    y: Math.random() * (height - 100) + 50,
                    vx: 0, vy: 0,
                    radius: 15
                });
            }
        });
        
        // Add links
        links = [...(data.graph.links || [])];
        
        // Auto-link causes to problem node
        if (data.fields.arbre_probleme && nodes.length > 0) {
            const problemNode = nodes.find(n => n.type === 'problem');
            if (!problemNode && data.fields.arbre_probleme) {
                nodes.push({
                    id: 'problem_central',
                    label: data.fields.arbre_probleme.substring(0, 40),
                    type: 'problem',
                    x: width / 2,
                    y: height / 2,
                    vx: 0, vy: 0,
                    radius: 30
                });
            }
        }
        
        updateStats();
        updateLinkSelects();
    }

    function animate() {
        if (physicsEnabled) {
            applyPhysics();
        }
        render();
        animationId = requestAnimationFrame(animate);
    }

    function applyPhysics() {
        const centerX = width / 2;
        const centerY = height / 2;
        
        // Repulsion between nodes
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                const dx = nodes[j].x - nodes[i].x;
                const dy = nodes[j].y - nodes[i].y;
                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                const minDist = (nodes[i].radius + nodes[j].radius) * 3;
                
                if (dist < minDist) {
                    const force = (minDist - dist) / dist * 0.5;
                    nodes[i].vx -= dx * force;
                    nodes[i].vy -= dy * force;
                    nodes[j].vx += dx * force;
                    nodes[j].vy += dy * force;
                }
            }
        }
        
        // Attraction for links
        links.forEach(link => {
            const source = nodes.find(n => n.id === link.source);
            const target = nodes.find(n => n.id === link.target);
            if (!source || !target) return;
            
            const dx = target.x - source.x;
            const dy = target.y - source.y;
            const dist = Math.sqrt(dx * dx + dy * dy) || 1;
            const force = (dist - 150) * 0.01;
            
            source.vx += dx / dist * force;
            source.vy += dy / dist * force;
            target.vx -= dx / dist * force;
            target.vy -= dy / dist * force;
        });
        
        // Center gravity
        nodes.forEach(node => {
            node.vx += (centerX - node.x) * 0.001;
            node.vy += (centerY - node.y) * 0.001;
        });
        
        // Apply velocity
        nodes.forEach(node => {
            if (node === dragNode) return;
            
            node.vx *= 0.9;
            node.vy *= 0.9;
            node.x += node.vx;
            node.y += node.vy;
            
            // Bounds
            node.x = Math.max(node.radius, Math.min(width - node.radius, node.x));
            node.y = Math.max(node.radius, Math.min(height - node.radius, node.y));
        });
    }

    function render() {
        ctx.clearRect(0, 0, width, height);
        
        ctx.save();
        ctx.translate(offsetX, offsetY);
        ctx.scale(scale, scale);
        
        // Draw links
        ctx.lineWidth = 1.5;
        links.forEach(link => {
            const source = nodes.find(n => n.id === link.source);
            const target = nodes.find(n => n.id === link.target);
            if (!source || !target) return;
            
            ctx.beginPath();
            ctx.moveTo(source.x, source.y);
            ctx.lineTo(target.x, target.y);
            ctx.strokeStyle = 'rgba(127, 239, 175, 0.3)';
            ctx.stroke();
            
            // Arrow
            const angle = Math.atan2(target.y - source.y, target.x - source.x);
            const arrowX = target.x - Math.cos(angle) * target.radius;
            const arrowY = target.y - Math.sin(angle) * target.radius;
            
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(arrowX - 10 * Math.cos(angle - 0.3), arrowY - 10 * Math.sin(angle - 0.3));
            ctx.lineTo(arrowX - 10 * Math.cos(angle + 0.3), arrowY - 10 * Math.sin(angle + 0.3));
            ctx.closePath();
            ctx.fillStyle = 'rgba(127, 239, 175, 0.5)';
            ctx.fill();
        });
        
        // Draw nodes
        nodes.forEach(node => {
            const isHovered = node === hoveredNode;
            
            // Glow
            if (isHovered) {
                ctx.beginPath();
                ctx.arc(node.x, node.y, node.radius + 8, 0, Math.PI * 2);
                const gradient = ctx.createRadialGradient(node.x, node.y, node.radius, node.x, node.y, node.radius + 15);
                gradient.addColorStop(0, COLORS[node.type] + '40');
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.fill();
            }
            
            // Node circle
            ctx.beginPath();
            ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
            ctx.fillStyle = COLORS[node.type] || '#888';
            ctx.fill();
            
            // Border
            ctx.strokeStyle = isHovered ? '#fff' : 'rgba(255,255,255,0.3)';
            ctx.lineWidth = isHovered ? 2 : 1;
            ctx.stroke();
            
            // Label
            ctx.fillStyle = '#fff';
            ctx.font = `${isHovered ? 'bold ' : ''}${Math.max(10, 12 / scale)}px Nunito`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const label = node.label.length > 15 ? node.label.substring(0, 15) + '...' : node.label;
            ctx.fillText(label, node.x, node.y + node.radius + 15);
        });
        
        ctx.restore();
    }

    function getNodeAt(x, y) {
        const mx = (x - offsetX) / scale;
        const my = (y - offsetY) / scale;
        
        for (let i = nodes.length - 1; i >= 0; i--) {
            const node = nodes[i];
            const dx = mx - node.x;
            const dy = my - node.y;
            if (dx * dx + dy * dy < node.radius * node.radius) {
                return node;
            }
        }
        return null;
    }

    function onMouseDown(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        dragNode = getNodeAt(x, y);
        
        if (dragNode) {
            isDragging = true;
        } else {
            isPanning = true;
        }
        
        lastMouse = { x: e.clientX, y: e.clientY };
    }

    function onMouseMove(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Hover detection
        const node = getNodeAt(x, y);
        if (node !== hoveredNode) {
            hoveredNode = node;
            updateTooltip(node, e.clientX, e.clientY);
        }
        
        if (isDragging && dragNode) {
            const dx = (e.clientX - lastMouse.x) / scale;
            const dy = (e.clientY - lastMouse.y) / scale;
            dragNode.x += dx;
            dragNode.y += dy;
            dragNode.vx = 0;
            dragNode.vy = 0;
        } else if (isPanning) {
            offsetX += e.clientX - lastMouse.x;
            offsetY += e.clientY - lastMouse.y;
        }
        
        lastMouse = { x: e.clientX, y: e.clientY };
    }

    function onMouseUp() {
        isDragging = false;
        isPanning = false;
        dragNode = null;
    }

    function onWheel(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.3, Math.min(3, scale * delta));
        
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        
        offsetX = mx - (mx - offsetX) * (newScale / scale);
        offsetY = my - (my - offsetY) * (newScale / scale);
        
        scale = newScale;
    }

    function onTouchStart(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            dragNode = getNodeAt(x, y);
            if (dragNode) {
                isDragging = true;
            } else {
                isPanning = true;
            }
            lastMouse = { x: touch.clientX, y: touch.clientY };
        }
    }

    function onTouchMove(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            
            if (isDragging && dragNode) {
                const dx = (touch.clientX - lastMouse.x) / scale;
                const dy = (touch.clientY - lastMouse.y) / scale;
                dragNode.x += dx;
                dragNode.y += dy;
            } else if (isPanning) {
                offsetX += touch.clientX - lastMouse.x;
                offsetY += touch.clientY - lastMouse.y;
            }
            
            lastMouse = { x: touch.clientX, y: touch.clientY };
        }
    }

    function onTouchEnd() {
        isDragging = false;
        isPanning = false;
        dragNode = null;
    }

    function updateTooltip(node, x, y) {
        const tooltip = document.getElementById('graph-tooltip');
        if (!node) {
            tooltip.classList.remove('visible');
            return;
        }
        
        tooltip.querySelector('.tooltip-title').textContent = node.label;
        tooltip.querySelector('.tooltip-type').textContent = node.type;
        tooltip.style.left = (x + 15) + 'px';
        tooltip.style.top = (y + 15) + 'px';
        tooltip.classList.add('visible');
    }

    function updateStats() {
        const statsEl = document.getElementById('graph-stats');
        if (statsEl) {
            statsEl.textContent = `NÅ“uds: ${nodes.length} | Liens: ${links.length}`;
        }
    }

    function zoomIn() { scale = Math.min(3, scale * 1.2); }
    function zoomOut() { scale = Math.max(0.3, scale * 0.8); }
    function resetView() { scale = 1; offsetX = 0; offsetY = 0; }
    
    function togglePhysics() {
        physicsEnabled = !physicsEnabled;
        const btn = document.getElementById('physics-btn');
        if (btn) {
            btn.style.background = physicsEnabled ? 'var(--green-subtle)' : 'var(--bg-elevated)';
        }
        showToast(physicsEnabled ? 'Physique activÃ©e' : 'Physique dÃ©sactivÃ©e');
    }

    function addNode(nodeData) {
        nodes.push({
            id: nodeData.id || 'node_' + Date.now(),
            label: nodeData.label,
            type: nodeData.type || 'concept',
            x: nodeData.x || width / 2 + (Math.random() - 0.5) * 100,
            y: nodeData.y || height / 2 + (Math.random() - 0.5) * 100,
            vx: 0, vy: 0,
            radius: nodeData.radius || 20
        });
        updateStats();
        updateLinkSelects();
    }

    function addLink(source, target, type) {
        if (source && target && source !== target) {
            links.push({ source, target, type: type || 'related' });
            updateStats();
        }
    }

    function getNodes() { return nodes; }
    function getLinks() { return links; }

    return {
        init, loadFromData, zoomIn, zoomOut, resetView, togglePhysics,
        addNode, addLink, getNodes, getLinks
    };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIALIZATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    loadProject();
    initNavigation();
    initFields();
    initChecklist();
    renderActors();
    renderVeille();
    renderTree();
    updateDashboard();
    
    // Initialize graph after a small delay to ensure DOM is ready
    setTimeout(() => GraphView.init(), 100);
});

function initNavigation() {
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const section = tab.dataset.section;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(section)?.classList.add('active');
            
            if (section === 'graph') {
                GraphView.loadFromData();
            }
        });
    });
}

function initFields() {
    document.querySelectorAll('[data-field]').forEach(el => {
        el.addEventListener('input', debounce(() => {
            data.fields[el.dataset.field] = el.value;
            saveProject(false);
            updateDashboard();
        }, 500));
    });
}

function initChecklist() {
    const container = document.getElementById('checklist');
    if (!container) return;
    
    container.innerHTML = CHECKLIST_ITEMS.map((text, i) => `
        <div class="checklist-item ${data.checklist['c' + i] ? 'completed' : ''}" onclick="toggleChecklist(${i})">
            <div class="checkbox">${data.checklist['c' + i] ? 'âœ“' : ''}</div>
            <span class="checklist-text">${text}</span>
        </div>
    `).join('');
}

function toggleChecklist(i) {
    data.checklist['c' + i] = !data.checklist['c' + i];
    saveProject(false);
    initChecklist();
}

function toggleCard(card) { card.classList.toggle('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TREE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateTreeProblem() {
    const input = document.getElementById('tree-problem-input');
    const display = document.getElementById('tree-problem-display');
    if (input && display) {
        display.textContent = input.value || 'â†’ ProblÃ¨me central â†';
    }
}

function addTreeItem(type) {
    const inputId = type === 'cause' ? 'cause-input' : 'effect-input';
    const input = document.getElementById(inputId);
    if (!input || !input.value.trim()) return;
    
    if (!data.tree) data.tree = { causes: [], effects: [] };
    if (!data.tree.causes) data.tree.causes = [];
    if (!data.tree.effects) data.tree.effects = [];
    
    const item = { id: Date.now().toString(), text: input.value.trim() };
    
    if (type === 'cause') {
        data.tree.causes.push(item);
    } else {
        data.tree.effects.push(item);
    }
    
    input.value = '';
    saveProject(false);
    renderTree();
    GraphView.loadFromData();
}

function removeTreeItem(type, id) {
    if (!data.tree) return;
    if (type === 'cause') data.tree.causes = (data.tree.causes || []).filter(c => c.id !== id);
    else data.tree.effects = (data.tree.effects || []).filter(e => e.id !== id);
    saveProject(false);
    renderTree();
    GraphView.loadFromData();
}

function renderTree() {
    const causesContainer = document.getElementById('tree-causes-list');
    const effectsContainer = document.getElementById('tree-effects-list');
    
    if (!data.tree) data.tree = { causes: [], effects: [] };
    
    const causes = data.tree.causes || [];
    const effects = data.tree.effects || [];
    
    if (causesContainer) {
        causesContainer.innerHTML = causes.length === 0 
            ? '<p class="text-muted text-sm">Aucune cause</p>'
            : causes.map(c => `
                <div class="tree-item cause">
                    <span class="tree-item-text">${escapeHtml(c.text)}</span>
                    <button class="tree-item-delete" onclick="removeTreeItem('cause', '${c.id}')">Ã—</button>
                </div>
            `).join('');
    }
    
    if (effectsContainer) {
        effectsContainer.innerHTML = effects.length === 0
            ? '<p class="text-muted text-sm">Aucun effet</p>'
            : effects.map(e => `
                <div class="tree-item effect">
                    <span class="tree-item-text">${escapeHtml(e.text)}</span>
                    <button class="tree-item-delete" onclick="removeTreeItem('effect', '${e.id}')">Ã—</button>
                </div>
            `).join('');
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addActor() {
    const name = document.getElementById('actor-name').value.trim();
    if (!name) return showToast('Entrez un nom', 'error');
    
    const actor = {
        id: Date.now().toString(),
        name,
        type: document.getElementById('actor-type').value,
        influence: document.getElementById('actor-influence').value
    };
    
    data.actors.push(actor);
    saveProject(false);
    renderActors();
    closeModal('actor-modal');
    document.getElementById('actor-name').value = '';
    showToast('Acteur ajoutÃ©');
    updateDashboard();
    GraphView.loadFromData();
}

function removeActor(id) {
    data.actors = data.actors.filter(a => a.id !== id);
    saveProject(false);
    renderActors();
    updateDashboard();
    GraphView.loadFromData();
}

function renderActors() {
    const container = document.getElementById('actors-list');
    if (!container) return;
    
    if (data.actors.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><p>Aucun acteur</p></div>';
        return;
    }
    
    const icons = { ally: 'ğŸ¤', target: 'ğŸ¯', neutral: 'âš–ï¸', opponent: 'ğŸš«' };
    const labels = { ally: 'AlliÃ©', target: 'Cible', neutral: 'Neutre', opponent: 'Opposant' };
    
    container.innerHTML = data.actors.map(a => `
        <div class="actor-card">
            <div class="actor-avatar ${a.type}">${icons[a.type] || 'ğŸ‘¤'}</div>
            <div class="actor-info">
                <div class="actor-name">${escapeHtml(a.name)}</div>
                <div class="actor-meta">${labels[a.type]} â€¢ ${a.influence}</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="removeActor('${a.id}')">ğŸ—‘ï¸</button>
        </div>
    `).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VEILLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addVeille() {
    const title = document.getElementById('veille-title').value.trim();
    if (!title) return showToast('Entrez un titre', 'error');
    
    data.veille.push({
        id: Date.now().toString(),
        title,
        url: document.getElementById('veille-url').value.trim(),
        category: document.getElementById('veille-category').value,
        date: new Date().toISOString()
    });
    
    saveProject(false);
    renderVeille();
    closeModal('veille-modal');
    document.getElementById('veille-title').value = '';
    document.getElementById('veille-url').value = '';
    showToast('Source ajoutÃ©e');
    updateDashboard();
    GraphView.loadFromData();
}

function removeVeille(id) {
    data.veille = data.veille.filter(v => v.id !== id);
    saveProject(false);
    renderVeille();
    updateDashboard();
    GraphView.loadFromData();
}

function renderVeille() {
    const container = document.getElementById('veille-list');
    if (!container) return;
    
    if (data.veille.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“°</div><p>Aucune source</p></div>';
        return;
    }
    
    const cats = { politique: 'ğŸ›ï¸', social: 'ğŸ‘¥', economique: 'ğŸ’°', environnement: 'ğŸŒ' };
    
    container.innerHTML = data.veille.map(v => `
        <div class="actor-card">
            <div class="actor-avatar" style="background: rgba(251,191,36,0.2)">${cats[v.category] || 'ğŸ“Œ'}</div>
            <div class="actor-info">
                <div class="actor-name">${escapeHtml(v.title)}</div>
                <div class="actor-meta">${v.url ? `<a href="${escapeHtml(v.url)}" target="_blank" style="color:var(--lilac-soft)">ğŸ”—</a> â€¢ ` : ''}${new Date(v.date).toLocaleDateString('fr-FR')}</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="removeVeille('${v.id}')">ğŸ—‘ï¸</button>
        </div>
    `).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRAPH NODES & LINKS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addGraphNode() {
    const name = document.getElementById('node-name').value.trim();
    if (!name) return showToast('Entrez un nom', 'error');
    
    const type = document.getElementById('node-type').value;
    const nodeData = {
        id: 'node_' + Date.now(),
        label: name,
        type: type
    };
    
    if (!data.graph) data.graph = { nodes: [], links: [] };
    if (!data.graph.nodes) data.graph.nodes = [];
    
    data.graph.nodes.push(nodeData);
    GraphView.addNode(nodeData);
    
    saveProject(false);
    closeModal('node-modal');
    document.getElementById('node-name').value = '';
    showToast('Concept ajoutÃ©');
    updateDashboard();
}

function addQuickNode(type) {
    const label = prompt(type === 'cause' ? 'Nouvelle cause:' : 'Nouvel effet:');
    if (!label || !label.trim()) return;
    
    const nodeData = {
        id: type + '_' + Date.now(),
        label: label.trim(),
        type: type
    };
    
    if (!data.graph) data.graph = { nodes: [], links: [] };
    if (!data.graph.nodes) data.graph.nodes = [];
    
    data.graph.nodes.push(nodeData);
    GraphView.addNode(nodeData);
    
    saveProject(false);
    showToast((type === 'cause' ? 'Cause' : 'Effet') + ' ajoutÃ©');
}

function updateLinkSelects() {
    const sourceSelect = document.getElementById('link-source');
    const targetSelect = document.getElementById('link-target');
    if (!sourceSelect || !targetSelect) return;
    
    const nodes = GraphView.getNodes();
    const options = nodes.map(n => `<option value="${n.id}">${n.label}</option>`).join('');
    
    sourceSelect.innerHTML = options;
    targetSelect.innerHTML = options;
}

function addGraphLink() {
    const source = document.getElementById('link-source').value;
    const target = document.getElementById('link-target').value;
    const type = document.getElementById('link-type').value;
    
    if (!source || !target || source === target) {
        return showToast('SÃ©lectionnez deux nÅ“uds diffÃ©rents', 'error');
    }
    
    if (!data.graph) data.graph = { nodes: [], links: [] };
    if (!data.graph.links) data.graph.links = [];
    
    data.graph.links.push({ source, target, type });
    GraphView.addLink(source, target, type);
    
    saveProject(false);
    closeModal('link-modal');
    showToast('Lien crÃ©Ã©');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateDashboard() {
    const filled = Object.values(data.fields).filter(v => v && v.toString().trim()).length;
    const totalFields = 20;
    const progress = Math.min(100, Math.round((filled / totalFields) * 100));
    
    const nodes = GraphView.getNodes();
    const links = GraphView.getLinks();
    
    setText('stat-progress', progress + '%');
    setText('stat-nodes', nodes.length);
    setText('stat-links', links.length);
    setText('stat-veille', data.veille.length);
    
    const bar = document.getElementById('global-progress-bar');
    if (bar) bar.style.width = progress + '%';
    
    const voirFields = ['domino_pourquoi', 'domino_valeurs', 'domino_changements'];
    const jugerFields = ['swot_forces', 'swot_faiblesses', 'arbre_probleme'];
    const agirFields = ['smart_s', 'smart_m', 'smart_a'];
    
    const calcPhase = (fields) => Math.round(fields.filter(f => data.fields[f] && data.fields[f].trim()).length / fields.length * 100);
    
    setText('prog-voir', calcPhase(voirFields) + '%');
    setText('prog-juger', calcPhase(jugerFields) + '%');
    setText('prog-agir', calcPhase(agirFields) + '%');
}

function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE / LOAD / EXPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveProject(notify = true) {
    data.meta.updated = new Date().toISOString();
    localStorage.setItem('plaidoyer_v4', JSON.stringify(data));
    if (notify) showToast('SauvegardÃ©');
}

function loadProject() {
    const saved = localStorage.getItem('plaidoyer_v4');
    if (saved) {
        try {
            const loaded = JSON.parse(saved);
            data = {
                meta: loaded.meta || data.meta,
                fields: loaded.fields || {},
                actors: loaded.actors || [],
                veille: loaded.veille || [],
                checklist: loaded.checklist || {},
                tree: { causes: (loaded.tree?.causes) || [], effects: (loaded.tree?.effects) || [] },
                graph: { nodes: (loaded.graph?.nodes) || [], links: (loaded.graph?.links) || [] }
            };
            
            Object.entries(data.fields).forEach(([k, v]) => {
                const el = document.querySelector(`[data-field="${k}"]`);
                if (el) el.value = v;
            });
            
            updateTreeProblem();
        } catch (e) { console.error('Load error:', e); }
    }
}

function exportProject(format) {
    const filename = `plaidoyer_${new Date().toISOString().slice(0, 10)}`;
    let content, type, ext;
    
    switch (format) {
        case 'json':
            content = JSON.stringify(data, null, 2);
            type = 'application/json'; ext = 'json';
            break;
        case 'md':
            content = generateMarkdown();
            type = 'text/markdown'; ext = 'md';
            break;
        case 'html':
            content = generateExportHTML();
            type = 'text/html'; ext = 'html';
            break;
        case 'gexf':
            content = generateGEXF();
            type = 'application/xml'; ext = 'gexf';
            break;
        case 'csv':
            content = generateCSV();
            type = 'text/csv'; ext = 'csv';
            break;
        default: return;
    }
    
    downloadFile(content, `${filename}.${ext}`, type);
    closeModal('export-modal');
    showToast(`Export ${format.toUpperCase()} OK`);
}

function generateMarkdown() {
    let md = `# Projet de Plaidoyer\n\n*${new Date().toLocaleDateString('fr-FR')}*\n\n`;
    Object.entries(data.fields).forEach(([k, v]) => {
        if (v && v.trim()) md += `## ${k.replace(/_/g, ' ')}\n\n${v}\n\n`;
    });
    if (data.actors.length > 0) {
        md += `## Acteurs\n\n`;
        data.actors.forEach(a => md += `- **${a.name}** (${a.type})\n`);
    }
    return md;
}

function generateExportHTML() {
    return `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Plaidoyer</title><style>body{font-family:system-ui;max-width:800px;margin:0 auto;padding:2rem;background:#1a1a2e;color:#eee}h1{color:#7fefaf}h2{color:#c9b8ff}</style></head><body><h1>Projet de Plaidoyer</h1>${Object.entries(data.fields).filter(([k,v])=>v&&v.trim()).map(([k,v])=>`<h2>${k.replace(/_/g,' ')}</h2><p>${v}</p>`).join('')}</body></html>`;
}

function generateGEXF() {
    const nodes = GraphView.getNodes();
    const links = GraphView.getLinks();
    
    let gexf = `<?xml version="1.0" encoding="UTF-8"?>
<gexf xmlns="http://www.gexf.net/1.2draft" version="1.2">
  <graph mode="static" defaultedgetype="directed">
    <nodes>
${nodes.map(n => `      <node id="${n.id}" label="${escapeHtml(n.label)}"/>`).join('\n')}
    </nodes>
    <edges>
${links.map((l, i) => `      <edge id="${i}" source="${l.source}" target="${l.target}"/>`).join('\n')}
    </edges>
  </graph>
</gexf>`;
    return gexf;
}

function generateCSV() {
    let csv = 'Type,ID,Label,Extra\n';
    GraphView.getNodes().forEach(n => csv += `node,${n.id},"${n.label}",${n.type}\n`);
    GraphView.getLinks().forEach(l => csv += `link,${l.source}â†’${l.target},"${l.type}",\n`);
    return csv;
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type + ';charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importProject(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            localStorage.setItem('plaidoyer_v4', ev.target.result);
            location.reload();
        } catch (err) { showToast('Fichier invalide', 'error'); }
    };
    reader.readAsText(file);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id) { document.getElementById(id)?.classList.add('active'); if (id === 'link-modal') updateLinkSelects(); }
function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

function showToast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${type === 'success' ? 'âœ…' : 'âŒ'}</span><span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

function escapeHtml(text) {
    if (!text) return '';
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

document.addEventListener('keydown', e => {
    if (e.ctrlKey || e.metaKey) {
        if (e.key === 's') { e.preventDefault(); saveProject(); }
        if (e.key === 'e') { e.preventDefault(); openModal('export-modal'); }
    }
    if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
});

setInterval(() => saveProject(false), 30000);
console.log('ğŸ•¸ï¸ Plaidoyer Citoyen v4.0 Graph Edition');
    </script>
</body>
</html>
