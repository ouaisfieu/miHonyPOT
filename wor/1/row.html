<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>WAR ROOM — Mission Control</title>

  <!-- réutilise ton style.css existant -->
  <link rel="stylesheet" href="./style.css" />

  <style>
    :root{
      --hud: rgba(17,21,35,.78);
      --hud2: rgba(17,21,35,.55);
      --glass: blur(10px) saturate(160%);
    }
    body{ overflow-x:hidden; }
    .bg{
      position:fixed; inset:0; z-index:-2;
      width:100vw; height:100vh;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.22), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(0,212,255,.18), transparent 50%),
                  linear-gradient(180deg, var(--bg), var(--bg));
    }
    canvas.bgC{
      position:fixed; inset:0; z-index:-1;
      width:100vw; height:100vh;
      opacity:.95;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: var(--glass);
      background: color-mix(in oklab, var(--bg) 75%, transparent);
      border-bottom:1px solid var(--line);
    }
    .topbar .wrap{
      padding:14px 0;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .wmTitle{display:flex; gap:12px; align-items:center}
    .wmTitle h1{font-size:1.05rem; margin:0}
    .wmTitle .kicker{margin:0; font-family:var(--mono); letter-spacing:.14em; text-transform:uppercase; font-size:.78rem; color:var(--muted)}

    .hudNav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .hudNav a{
      text-decoration:none;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: color-mix(in oklab, var(--card) 70%, transparent);
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      margin-top:14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.1fr .9fr; align-items:start; }
    }

    .panel{
      background: color-mix(in oklab, var(--card) 85%, transparent);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, transparent), transparent);
      border-bottom:1px solid var(--line);
    }
    .panelHead h2{margin:0; font-size:1rem}
    .panelBody{padding:14px 16px}

    .kpis{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr;
    }
    @media (min-width: 980px){
      .kpis{ grid-template-columns: 1fr 1fr; }
    }
    .kpi{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      background: color-mix(in oklab, var(--bg) 62%, var(--card));
    }
    .kpiTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .kpiName{font-family:var(--mono); letter-spacing:.12em; text-transform:uppercase; font-size:.75rem; color:var(--muted)}
    .kpiVal{font-weight:900; font-size:1.25rem}
    .bar{height:10px; border-radius:999px; border:1px solid var(--line); overflow:hidden; margin-top:10px;
         background: color-mix(in oklab, var(--bg) 65%, var(--card));}
    .fill{height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition:width 650ms ease}
    .mini{font-size:.85rem}
    .mono{font-family:var(--mono)}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      font-family:var(--mono);
      font-size:.82rem;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: color-mix(in oklab, var(--card) 72%, transparent);
      white-space:nowrap;
    }
    .tag.good{ border-color: color-mix(in oklab, #34d399 60%, var(--line)); }
    .tag.warn{ border-color: color-mix(in oklab, #fbbf24 60%, var(--line)); }
    .tag.bad { border-color: color-mix(in oklab, #fb7185 60%, var(--line)); }

    .tables{display:grid; gap:14px; grid-template-columns:1fr;}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    td{
      padding:10px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--bg) 62%, var(--card));
      vertical-align:top;
    }
    td:first-child{border-radius:14px 0 0 14px}
    td:last-child{border-radius:0 14px 14px 0; width:1%}
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:800}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    .ringsWrap{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    .ringsCard{
      border:1px solid var(--line);
      border-radius: 18px;
      background: color-mix(in oklab, var(--card) 75%, transparent);
      padding:12px;
      backdrop-filter: var(--glass);
    }
    canvas#rings{
      width:100%;
      height:auto;
      display:block;
      border-radius:16px;
      border:1px solid var(--line);
      background: radial-gradient(900px 420px at 20% 0%, rgba(124,92,255,.14), transparent 60%),
                  radial-gradient(900px 420px at 90% 10%, rgba(0,212,255,.10), transparent 55%),
                  color-mix(in oklab, var(--bg) 58%, var(--card));
    }
    .dikwGrid{display:grid; gap:10px; grid-template-columns:1fr;}
    @media(min-width:980px){ .dikwGrid{ grid-template-columns:1fr 1fr; } }
    .dikwGrid .full{grid-column:1/-1}

    .footHint{
      margin-top:14px;
      color:var(--muted);
      font-size:.9rem;
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>
  <canvas class="bgC" id="bg" aria-hidden="true"></canvas>

  <header class="topbar">
    <div class="wrap">
      <div class="wmTitle">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <div class="kicker">WAR ROOM / Mission Control</div>
          <h1>Ultime — digne de la NASA × CodePen (offline)</h1>
        </div>
      </div>
      <nav class="hudNav" aria-label="Navigation">
        <a href="./index.html">Base</a>
        <a href="./ops.html">OPS</a>
        <a href="./landing-virus.html">Landing</a>
        <a href="./eux.html">Eux</a>
      </nav>
    </div>
  </header>

  <main class="wrap" style="padding:14px 0 30px">
    <section class="panel">
      <div class="panelHead">
        <h2>Situation</h2>
        <span id="health_tag" class="tag warn">HEALTH: AMBER</span>
      </div>
      <div class="panelBody">
        <div class="kpis">
          <div class="kpi">
            <div class="kpiTop">
              <div class="kpiName">Récursivité</div>
              <div class="kpiVal" id="k_recurse">0%</div>
            </div>
            <div class="bar"><div class="fill" id="b_recurse"></div></div>
            <div class="mini muted mono" id="m_recurse">actions≈0</div>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div class="kpiName">Outreach done</div>
              <div class="kpiVal" id="k_outreach">0</div>
            </div>
            <div class="bar"><div class="fill" id="b_outreach"></div></div>
            <div class="mini muted mono" id="m_outreach">liste non importée</div>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div class="kpiName">Logs</div>
              <div class="kpiVal" id="k_logs">0</div>
            </div>
            <div class="mini muted mono" id="m_lastlog">—</div>
          </div>

          <div class="kpi">
            <div class="kpiTop">
              <div class="kpiName">Instances</div>
              <div class="kpiVal" id="k_instances">0</div>
            </div>
            <div class="mini muted mono" id="m_lastinstance">—</div>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btn_snapshot">Snapshot JSON</button>
          <button class="btn" id="btn_reset">Reset local</button>
          <button class="btn" id="btn_refresh">Refresh</button>
        </div>

        <p class="footHint mono">
          Stockage partagé: <strong>localStorage["plaidoyer_ecosystem"]</strong> — pas de trackers, pas d’automatisation abusive. :contentReference[oaicite:1]{index=1}
        </p>
      </div>
    </section>

    <div class="grid">
      <!-- LEFT -->
      <section class="panel">
        <div class="panelHead">
          <h2>OPS Queue (P1/P2/P3)</h2>
          <span class="tag">TODO ⇄ DONE</span>
        </div>
        <div class="panelBody">
          <div class="row" style="align-items:flex-end">
            <label style="min-width:140px; margin:0">
              Phase
              <select id="q_phase">
                <option value="P1">P1 — Amorçage</option>
                <option value="P2">P2 — Diffusion</option>
                <option value="P3">P3 — Consolidation</option>
              </select>
            </label>

            <label style="flex:1; margin:0">
              Action (enter pour ajouter)
              <input id="q_text" placeholder="Ex: publier la landing / envoyer 3 relais consentis / écrire DIKW #07" />
            </label>

            <button class="btn primary" id="btn_q_add">Ajouter</button>
          </div>

          <div class="tables" style="margin-top:10px">
            <table aria-label="Queue">
              <tbody id="queue"></tbody>
            </table>
          </div>

          <div class="panel" style="box-shadow:none; margin-top:12px">
            <div class="panelHead">
              <h2>Recent logs</h2>
              <span class="tag">6 derniers</span>
            </div>
            <div class="panelBody">
              <table aria-label="Logs">
                <tbody id="recent"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="ringsWrap">
        <section class="ringsCard">
          <div class="panelHead" style="padding:0 0 10px; border-bottom:none; background:none">
            <h2>Concentric Strategy Board</h2>
            <span class="tag">DIFF / ANCR / EXP</span>
          </div>
          <canvas id="rings" width="720" height="520" aria-label="Rings"></canvas>
          <p class="muted mini" style="margin:10px 0 0">
            Diffusion = progression outreach · Ancrage = queue done · Expansion = récursivité.
          </p>
        </section>

        <section class="panel">
          <div class="panelHead">
            <h2>DIKW (Data → Info → Knowledge → Action)</h2>
            <span class="tag">export MD</span>
          </div>
          <div class="panelBody">
            <div class="dikwGrid">
              <label class="full">Data (facts bruts)
                <textarea id="dikw_data" rows="3" placeholder="Ce que j’ai observé / collecté…"></textarea>
              </label>
              <label>Info (mise en forme)
                <textarea id="dikw_info" rows="3" placeholder="Ce que ça signifie / contexte…"></textarea>
              </label>
              <label>Knowledge (pattern / modèle)
                <textarea id="dikw_know" rows="3" placeholder="Le pattern, la règle, le mécanisme…"></textarea>
              </label>
              <label class="full">Action (prochaine étape vérifiable)
                <textarea id="dikw_act" rows="3" placeholder="Une action simple, claire, mesurable…"></textarea>
              </label>
            </div>

            <div class="row">
              <button class="btn primary" id="btn_dikw_save">Sauver</button>
              <button class="btn" id="btn_dikw_export">Exporter DIKW.md</button>
            </div>

            <p class="muted small" style="margin-top:10px">
              Ce module s’appuie sur le schéma DIKW utilisé dans le wargame / la méthode. :contentReference[oaicite:2]{index=2}
            </p>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <script>
  "use strict";

  /**
   * WAR ROOM — offline mission control
   * Stockage partagé: localStorage["plaidoyer_ecosystem"]
   * Objectif: coordonner / documenter / mesurer, sans automatiser des abus.
   *
   * Base issue de ton fichier uploadé puis complétée en page complète. :contentReference[oaicite:3]{index=3}
   */

  const KEY = "plaidoyer_ecosystem";
  const $ = (id) => document.getElementById(id);

  function nowIso(){ return new Date().toISOString(); }

  function loadStore(){
    try {
      return JSON.parse(localStorage.getItem(KEY)) || {
        instances: [],
        contacts: [],
        logs: [],
        ops: { queue: [], dikw: [] }
      };
    } catch {
      return { instances: [], contacts: [], logs: [], ops: { queue: [], dikw: [] } };
    }
  }
  function saveStore(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function addLog(event, meta={}){
    const s = loadStore();
    s.logs = s.logs || [];
    s.logs.unshift({ ts: nowIso(), event, meta });
    s.logs = s.logs.slice(0, 200);
    saveStore(s);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function computeKPIs(s){
    const contacts = (s.contacts || []);
    const done = contacts.filter(c => c && c.done).length;
    const total = contacts.length;

    const logs = (s.logs || []).length;
    const instances = (s.instances || []).length;

    const queue = (s.ops && s.ops.queue) ? s.ops.queue : [];
    const qDone = queue.filter(x => x.done).length;
    const qTotal = queue.length;

    const dikw = (s.ops && s.ops.dikw) ? s.ops.dikw : [];
    const actions = qDone + done + dikw.length;
    const recurse = Math.round(100 * (actions / Math.max(1, (instances || 1) * 3))); // 3 actions/instance = 100%
    const recursePct = clamp(recurse, 0, 100);

    const outreachPct = total ? Math.round(100 * done / total) : clamp(done * 8, 0, 100);

    return { done, total, logs, instances, qDone, qTotal, recursePct, outreachPct };
  }

  function setTag(tagEl, level){
    tagEl.classList.remove("good","warn","bad");
    if(level === "good") tagEl.classList.add("good");
    if(level === "warn") tagEl.classList.add("warn");
    if(level === "bad")  tagEl.classList.add("bad");
  }

  function renderKPIs(){
    const s = loadStore();
    const k = computeKPIs(s);

    $("k_recurse").textContent = `${k.recursePct}%`;
    $("b_recurse").style.width = `${k.recursePct}%`;
    $("m_recurse").textContent = `actions≈${(k.qDone + k.done + ((s.ops && s.ops.dikw) ? s.ops.dikw.length : 0))}`;

    $("k_outreach").textContent = `${k.done}`;
    $("b_outreach").style.width = `${k.outreachPct}%`;
    $("m_outreach").textContent = k.total ? `${k.done}/${k.total}` : `liste non importée`;

    $("k_logs").textContent = `${k.logs}`;
    const last = (s.logs && s.logs[0]) ? s.logs[0] : null;
    $("m_lastlog").textContent = last ? `${last.ts} — ${last.event}` : "—";

    $("k_instances").textContent = `${k.instances}`;
    const li = (s.instances && s.instances[0]) ? s.instances[0] : null;
    $("m_lastinstance").textContent = li ? `dernier: ${li.instance || li.name || "—"}` : "—";

    // Health heuristic
    const tag = $("health_tag");
    const hasMotion = (k.qDone + k.done) > 0;
    let level = "warn";
    let label = "HEALTH: AMBER";
    if(k.recursePct >= 60 && hasMotion){ level="good"; label="HEALTH: GREEN"; }
    if(!hasMotion && k.logs < 3){ level="bad"; label="HEALTH: RED"; }
    tag.textContent = label;
    setTag(tag, level);

    renderRecent(s);
    renderQueue(s);
    drawRings(k);
  }

  function renderRecent(s){
    const tb = $("recent");
    tb.innerHTML = "";
    (s.logs || []).slice(0, 6).forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="mono mini">${escapeHtml(l.ts.slice(11,19))}</span> <span class="muted mini">${escapeHtml(l.event)}</span></td>
        <td><span class="tag">${escapeHtml((l.meta && l.meta.phase) ? l.meta.phase : "LOG")}</span></td>`;
      tb.appendChild(tr);
    });
    if(!(s.logs || []).length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted">—</td><td class="muted">—</td>`;
      tb.appendChild(tr);
    }
  }

  function renderQueue(s){
    const tb = $("queue");
    tb.innerHTML = "";
    const q = (s.ops && s.ops.queue) ? s.ops.queue : [];
    q.slice(0, 10).forEach(item => {
      const tr = document.createElement("tr");
      const status = item.done ? `<span class="tag good">DONE</span>` : `<span class="tag warn">TODO</span>`;
      tr.innerHTML = `
        <td>
          <div><span class="tag">${escapeHtml(item.phase || "P1")}</span> <strong>${escapeHtml(item.text || "")}</strong></div>
          <div class="muted mini mono">${escapeHtml(item.ts || "")}</div>
        </td>
        <td>
          ${status}
          <button class="btn small" data-qdone="${item.id}">${item.done ? "↺" : "✓"}</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    if(!q.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted">Aucune action. Ajoute une ligne (P1/P2/P3).</td><td class="muted">—</td>`;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-qdone]").forEach(btn => {
      btn.addEventListener("click", () => toggleQueue(btn.getAttribute("data-qdone")));
    });
  }

  function toggleQueue(id){
    const s = loadStore();
    const q = (s.ops && s.ops.queue) ? s.ops.queue : [];
    const it = q.find(x => x.id === id);
    if(!it) return;
    it.done = !it.done;
    it.ts = it.ts || nowIso();
    saveStore(s);
    addLog(it.done ? "queue_done" : "queue_reopen", { phase: it.phase || "P1" });
    renderKPIs();
  }

  function addQueue(){
    const phase = $("q_phase").value;
    const text = ($("q_text").value || "").trim();
    if(!text) return;

    const s = loadStore();
    s.ops = s.ops || {};
    s.ops.queue = s.ops.queue || [];
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2);
    s.ops.queue.unshift({ id, phase, text, done:false, ts: nowIso() });
    saveStore(s);
    addLog("queue_add", { phase });
    $("q_text").value = "";
    renderKPIs();
  }

  function saveDIKW(){
    const data = ($("dikw_data").value || "").trim();
    const info = ($("dikw_info").value || "").trim();
    const know = ($("dikw_know").value || "").trim();
    const act  = ($("dikw_act").value || "").trim();
    if(!data && !info && !know && !act) return;

    const s = loadStore();
    s.ops = s.ops || {};
    s.ops.dikw = s.ops.dikw || [];
    s.ops.dikw.unshift({ ts: nowIso(), data, info, know, act });
    s.ops.dikw = s.ops.dikw.slice(0, 50);
    saveStore(s);
    addLog("dikw_save", { phase: "DIKW" });
    renderKPIs();
  }

  function exportDIKWmd(){
    const data = ($("dikw_data").value || "").trim();
    const info = ($("dikw_info").value || "").trim();
    const know = ($("dikw_know").value || "").trim();
    const act  = ($("dikw_act").value || "").trim();

    const md = [
      `# DIKW — ${nowIso()}`,
      ``,
      `## Data`,
      data || `—`,
      ``,
      `## Info`,
      info || `—`,
      ``,
      `## Knowledge`,
      know || `—`,
      ``,
      `## Action`,
      act || `—`,
      ``
    ].join("\n");

    download("DIKW.md", md, "text/markdown;charset=utf-8");
    addLog("dikw_export", { phase: "DIKW" });
  }

  function snapshot(){
    const s = loadStore();
    const k = computeKPIs(s);
    const payload = { ts: nowIso(), kpis: k, store: s };
    download("warroom-snapshot.json", JSON.stringify(payload, null, 2), "application/json;charset=utf-8");
    addLog("snapshot", { phase: "OPS" });
    renderKPIs();
  }

  function resetLocal(){
    if(!confirm("Reset localStorage[plaidoyer_ecosystem] ?")) return;
    localStorage.removeItem(KEY);
    // recrée un store propre + un log visible
    saveStore({ instances: [], contacts: [], logs: [], ops: { queue: [], dikw: [] } });
    addLog("reset", { phase: "OPS" });
    renderKPIs();
  }

  function download(filename, text, mime){
    const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // Rings canvas sizing
  function fitCanvas(canvas){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(520, Math.floor(rect.width * dpr));
    const h = Math.floor((rect.width * 0.72) * dpr);
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    return { dpr, w, h };
  }

  /* ===== Rings canvas: concentric strategy board ===== */
  function drawRings(k){
    const c = $("rings");
    fitCanvas(c);
    const ctx = c.getContext("2d");
    const W = c.width, H = c.height;
    ctx.clearRect(0,0,W,H);

    // background grid
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    for(let i=0;i<14;i++){
      const x = (W/14)*i;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
      const y = (H/14)*i;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    ctx.restore();

    const cx=W/2, cy=H/2;
    const base = Math.min(W,H);
    const rings = [
      { r: base*0.42, label:"DIFFUSION", pct: k.outreachPct, col1:"#7c5cff", col2:"#00d4ff" },
      { r: base*0.29, label:"ANCRAGE",   pct: clamp(Math.round((k.qDone / Math.max(1,k.qTotal))*100),0,100), col1:"#00d4ff", col2:"#7c5cff" },
      { r: base*0.16, label:"EXPANSION", pct: clamp(Math.round((k.recursePct + 10)/1.1),0,100), col1:"#7c5cff", col2:"#00d4ff" }
    ];

    rings.forEach((rg) => {
      ctx.lineWidth = Math.max(10, Math.round(base*0.025));
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.beginPath();
      ctx.arc(cx, cy, rg.r, 0, Math.PI*2);
      ctx.stroke();

      const grad = ctx.createLinearGradient(cx-rg.r, cy, cx+rg.r, cy);
      grad.addColorStop(0, rg.col1);
      grad.addColorStop(1, rg.col2);
      ctx.strokeStyle = grad;
      ctx.lineCap = "round";
      ctx.beginPath();
      const start = -Math.PI/2;
      const end = start + (Math.PI*2)*(rg.pct/100);
      ctx.arc(cx, cy, rg.r, start, end);
      ctx.stroke();

      ctx.save();
      ctx.fillStyle = "rgba(233,236,241,0.92)";
      ctx.font = `700 ${Math.max(14, Math.round(base*0.03))}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
      ctx.textAlign = "center";
      ctx.fillText(rg.label, cx, cy - rg.r + Math.max(18, Math.round(base*0.035)));
      ctx.font = `700 ${Math.max(13, Math.round(base*0.027))}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
      ctx.fillStyle = "rgba(169,178,195,0.95)";
      ctx.fillText(rg.pct + "%", cx, cy - rg.r + Math.max(42, Math.round(base*0.07)));
      ctx.restore();

      ctx.save();
      ctx.globalAlpha = 0.55;
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 2;
      const ticks = 24;
      for(let t=0;t<ticks;t++){
        const a = (Math.PI*2) * (t/ticks);
        const x1 = cx + Math.cos(a)*(rg.r - 16);
        const y1 = cy + Math.sin(a)*(rg.r - 16);
        const x2 = cx + Math.cos(a)*(rg.r + 16);
        const y2 = cy + Math.sin(a)*(rg.r + 16);
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      }
      ctx.restore();
    });

    // core
    ctx.save();
    const g2 = ctx.createRadialGradient(cx,cy,0,cx,cy,70);
    g2.addColorStop(0,"rgba(124,92,255,0.40)");
    g2.addColorStop(1,"rgba(0,212,255,0.02)");
    ctx.fillStyle = g2;
    ctx.beginPath(); ctx.arc(cx,cy,72,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,0.12)";
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.fillStyle="rgba(233,236,241,0.95)";
    ctx.font=`900 ${Math.max(16, Math.round(base*0.032))}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto`;
    ctx.textAlign="center";
    ctx.fillText("MISSION", cx, cy+8);
    ctx.restore();
  }

  /* ===== background starfield ===== */
  function starfield(){
    const c = $("bg");
    const ctx = c.getContext("2d");
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

    function resize(){
      c.width = Math.floor(innerWidth * dpr);
      c.height = Math.floor(innerHeight * dpr);
    }
    resize();
    addEventListener("resize", resize);

    const N = 220;
    const stars = Array.from({length:N}, () => ({
      x: Math.random(),
      y: Math.random(),
      z: Math.random(),
      s: Math.random()*0.8 + 0.2
    }));

    let t0 = performance.now();
    function frame(t){
      const dt = Math.min(48, t - t0); t0 = t;
      ctx.clearRect(0,0,c.width,c.height);

      // faint scanline
      ctx.save();
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      for(let y=0;y<c.height;y+=6){ ctx.fillRect(0,y,c.width,1); }
      ctx.restore();

      stars.forEach(st => {
        st.y += (dt*0.00004) * (0.35 + st.z);
        if(st.y > 1) st.y = 0;

        const x = st.x * c.width;
        const y = st.y * c.height;
        const r = (st.s * (0.7 + st.z)) * dpr;

        const a = 0.22 + 0.55*st.z;
        ctx.fillStyle = `rgba(233,236,241,${a})`;
        ctx.beginPath();
        ctx.arc(x,y,r,0,Math.PI*2);
        ctx.fill();

        if(st.z > 0.92 && Math.random() < 0.02){
          const g = ctx.createRadialGradient(x,y,0,x,y,40*dpr);
          g.addColorStop(0, "rgba(124,92,255,0.22)");
          g.addColorStop(1, "rgba(0,212,255,0.0)");
          ctx.fillStyle = g;
          ctx.beginPath(); ctx.arc(x,y,40*dpr,0,Math.PI*2); ctx.fill();
        }
      });

      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  function wire(){
    $("btn_q_add").addEventListener("click", addQueue);
    $("q_text").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addQueue(); } });

    $("btn_dikw_save").addEventListener("click", saveDIKW);
    $("btn_dikw_export").addEventListener("click", exportDIKWmd);

    $("btn_snapshot").addEventListener("click", snapshot);
    $("btn_reset").addEventListener("click", resetLocal);
    $("btn_refresh").addEventListener("click", renderKPIs);

    // initial log if empty
    const s = loadStore();
    if(!(s.logs || []).length){
      addLog("warroom_boot", { phase: "OPS" });
    }

    renderKPIs();
    starfield();

    // refresh every 2.5s (local only)
    setInterval(renderKPIs, 2500);

    addEventListener("resize", () => renderKPIs(), { passive:true });
  }

  wire();
  </script>
</body>
</html>
